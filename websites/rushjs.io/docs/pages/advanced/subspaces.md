---
title: Rush subspaces
---

## What are subspaces?

This feature enables a single monorepo to install using multiple PNPM lockfiles. A Rush **subspace** is a folder such as `common/config/subspaces/my-team/` that contains a **pnpm-lock.yaml** and its associated config files. In this model, each Rush project belongs to exactly one subspace. Subspaces are not "workspaces" -- there's still only one unified workspace, such that the `workspace:*` specifier can be used to depend on projects from other subspaces.

## What is the benefit?

Generally it's best to have a single lockfile for the entire monorepo, as this optimizes installation time and minimizes maintenance work for managing version conflicts. However, multiple lockfiles can have benefits in certain cases:

- **A very large codebase**: A lockfile can be thought of as giant multivariable equation, which gets solved by coordinating NPM package version choices across many projects to eliminate conflicts and minimize duplication. (The [Lockfile Explorer](@lfx/) docs explain this in depth.) Although partitioning projects into multiple lockfiles produces smaller equations, the overall maintenance work will be significantly greater than with one unified equation. However, at the scale where that equation becomes too complex to manage easily, dividing up the work can be more important than minimizing the total amount of work.

- **Decoupled project sets**: A large code base may have certain clusters of projects whose dependencies are not aligned with the rest of the repo. For example, suppose 50 projects comprise a legacy application that uses deprecated tooling or an outdated framework version, with no plan to ever modernize it. Moving these projects into a subspace enables their versioning to be managed independently.

- **Installation testing**: When publishing NPM packages, certain bugs cannot be reproduced using `workspace:*` symlinking. For example, phantom dependencies or incorrect `.npmignore` globs may not cause any problems when a library is tested within the monorepo, even though the published package would fail for external consumers. Moving test projects into a subspace (combined with [injected dependencies](./injected_deps.md)) produces a more accurate installation that can catch such problems, while still avoiding the overhead of actually publishing to a testing NPM registry.

## How many subspaces are we talking about?

We generally recommend "as few as possible" to minimize additional version management overhead. "One subspace per team" is a reasonable maximum limit. That said, this feature has been used successfully in a production monorepo with more than 1,000 subspaces.

> **Real world demo**
>
> This feature is enabled for the Rush Stack repository on GitHub,
> which has two subspaces:
>
> - [common/config/subspaces/build-tests-subspace](https://github.com/microsoft/rushstack/tree/main/common/config/subspaces/build-tests-subspace): used to test installation of published NPM packages
> - [common/config/subspaces/default](https://github.com/microsoft/rushstack/tree/main/common/config/subspaces/default): contains all other projects

## Feature design: Config files

Subspaces are created by defining their names in the [common/config/subspaces.json](../configs/subspaces_json.md) config file. Projects are added to a subspace using the `subspaceName` field for projects in [rush.json](../configs/rush_json.md).

The configuration for each subspace goes in a folder **common/config/subspaces/&lt;subspace-name&gt;/**, which may contain the following files:

- [`common-versions.json`](../configs/common-versions_json.md): Rush version overrides
- [`pnpm-config.json`](../configs/pnpm-config_json.md): PNPM version overrides
- `pnpm-lock.yaml`: The PNPM lockfile
- `repo-state.json`: A config file generated by Rush to prevent manual lockfile changes
- [`.npmrc`](../configs/npmrc.md): package manager configuration
- `.pnpmfile-subspace.cjs`: Programmatic version overrides, following the same specification as [`.pnpmfile.cjs`](../configs/pnpmfile_cjs.md) but specific to the subspace

The above files are NOT allowed under `common/config/rush/` folder when the subspaces feature is enabled. When enabling the feature, typically they would be moved to `common/config/subspaces/default/`.

Note that the following config files are NOT moved:

- `common/config/.npmrc-publish`: This file is used for Rush NPM publishing, regardless of which subspaces the published projects belong to
- `common/config/.pnpmfile.cjs`: This file can apply versioning overrides that will affect all subspaces in the monorepo. To avoid confusing interactions across lockfiles, in most cases it is better to use `.pnpmfile-subspace.cjs` instead.

Note that `common/config/rush/.pnpmfile.cjs` is still allowed, and can be used to apply overrides that affect all subspaces in the monorepo.

## Feature design: Mechanics

Without subspaces, Rush generates and installs the PNPM workspace in the `common/temp/` folder. With subspaces enabled, this will be performed separately in folders such as `common/temp/<subspace-name>`.

There are two basic modes of operation:

1. **Just a few subspaces:** You can set `"preventSelectingAllSubspaces": false` in `subspaces.json`, and `rush install` by default will install all subspaces.

2. **Lots of subspaces:** If installing all subspaces would consume too much time and disk space, then you can set `"preventSelectingAllSubspaces": true`. In this mode, when invoking commands like `rush install` or `rush update`, users MUST indicate the subspaces explicitly (`--subspace` parameter) or implicitly (via project selectors such as `--to`).

## Step-by-step: Migrating to use subspaces

1. Make sure your **rush.json** specifies `"rushVersion": "5.122.0"` or newer, and `"pnpmVersion": "8.7.6"` or newer.

2. Use **subspaces.json** to enable the feature and define the subspaces. You can copy the template for this file from the [subspaces.json](../configs/subspaces_json.md) docs, or use `rush init` to generate it. In this tutorial, we'll create one subspace called `install-test` for testing NPM packages.

   **common/config/rush/subspaces.json**

   ```js
   {
     "$schema": "https://developer.microsoft.com/json-schemas/rush/v5/subspaces.schema.json",

     /**
      * Set this flag to "true" to enable usage of subspaces.
      */
     "subspacesEnabled": false,

     /**
      * When a command such as "rush update" is invoked without the "--subspace" or "--to"
      * parameters, Rush will install all subspaces.  In a huge monorepo with numerous subspaces,
      * this would be extremely slow.  Set "preventSelectingAllSubspaces" to true to avoid this
      * mistake by always requiring selection parameters for commands such as "rush update".
      */
     "preventSelectingAllSubspaces": false,

     /**
      * The list of subspace names, which should be lowercase alphanumeric words separated by
      * hyphens, for example "my-subspace".  The corresponding config files will have paths
      * such as "common/config/subspaces/my-subspace/package-lock.yaml".
      */
     "subspaceNames": [
       // The "default" subspace always exists even if you don't define it,
       // but let's include it for clarity
       "default",

       "install-test" // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ Our secondary subspace name
     ]
   }
   ```

3. Create the `default` subspace folder and move the existing config files there:

   ```bash
   cd my-repo
   mkdir --parents common/config/subspaces/default

   # Move these files:
   mv common/config/rush/common-versions.json  common/config/subspaces/default/
   mv common/config/rush/pnpm-config.json      common/config/subspaces/default/
   mv common/config/rush/pnpm-lock.yaml        common/config/subspaces/default/
   mv common/config/rush/.npmrc                common/config/subspaces/default/

   # Rename this file:
   mv common/config/rush/.pnpmfile.cjs  common/config/subspaces/default/.pnpmfile-subspace.cjs
   ```

4. Create the `install-test` subspace folder:

   ```bash
   cd my-repo
   mkdir --parents common/config/subspaces/install-test
   ```

5. Assign projects to subspaces by editing `rush.json`. For example:

   **rush.json**

   ```js
   . . .

     "projects": [
       {
         "packageName": "my-library-test",
         "projectFolder": "test-projects/my-library-test",
         "subspaceName": "install-test"
       }

   . . .
   ```

   If `"subspaceName"` is omitted for any projects, they will belong to the `default` subspace.

6. Now update the lockfiles for the new subspaces:

   ```bash
   # Clean out the common/temp folder from before
   rush purge

   # Regenerate the "default" subspace:
   rush update --full --subspace default

   # Regenerate the "install-test" subspace:
   rush update --full --subspace install-test
   ```

   > **Note:** You can migrate to subspaces without using `--full` to regenerate any lockfiles,
   > but it is a more involved process may involve using a script to rewrite some paths in the
   > `pnpm-lock.yaml` files.

## See also

- [subspaces.json](../configs/subspaces_json.md) config file
- [rfc-4230-rush-subspaces.md](https://github.com/microsoft/rushstack/blob/main/common/docs/rfcs/rfc-4230-rush-subspaces.md): The original spec for this feature, which explains the motivation and design in more detail
